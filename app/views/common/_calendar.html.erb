<%= stylesheet_link_tag 'leaves_holidays', :plugin => 'redmine_leaves_holidays' %>
<table class="cal">
<thead>
<tr><th scope="col" title="<%= l(:label_week) %>" class="week-number"></th><% 7.times do |i| %><th scope="col"><%= day_name( (calendar.first_wday+i)%7 ) %></th><% end %></tr>
</thead>
<tbody>
<tr>
<% day = calendar.startdt
while day <= calendar.enddt %>
<%= ("<td class='week-number' title='#{ l(:label_week) }'>#{(day+(11-day.cwday)%7).cweek}</td>".html_safe) if day.cwday == calendar.first_wday %>
<td class="<%= day.month==calendar.month ? 'even' : 'odd' %><%= ' today' if Date.today == day %>">
<p class="day-num"><%= day.day %></p>

<% if @project %>
  <% 
      week_period = LeavesHolidaysLogic.week_period_from_date(day)
      leave_list = LeavesHolidaysLogic.leave_on_for_project(day, @project).flatten.uniq.sort{|a,b| a.leave_days_within(week_period[:start_date], week_period[:end_date]) <=> b.leave_days_within(week_period[:start_date], week_period[:end_date])}.reverse
  %>


  <% unless leave_list.empty? %>
    <% for leave in leave_list %>
      <% css_style = leave.css_style %>
      <% if leave.get_status == "accepted" %>
        <div class="leave" style="<%= css_style %>">
      <% else %>
        <div class="strip">

      <% end %>
        <strong><p><%= link_to "Leave \##{leave.id} - #{leave.issue.subject}", leave_request_path(leave), {:style => css_style} %></p></strong>
        <table class="leave-table">
        <th>
        <%= avatar(leave.user, :size => "30") %>
        </th>
        <th>
        <p>User: <%= link_to "#{leave.user.name}", user_path(leave.user), {:style => css_style} %></p>
        <% if leave.get_status != "accepted" %>
          <p>Status: <%= leave.get_status %></p>
        <% end  %>
        <% if leave.half_day? %><p><strong><%= leave.request_type.upcase %> Leave</strong></p><% end %></th>
        </table>
        </div>
      </div>
    <% end %>
    
  <% end %>

<% end %>

<% unless RedmineLeavesHolidays::Setting.defaults_settings(:display_only_leave) %>
  <% calendar.events_on(day).each do |i| %>
    <% if i.is_a? Issue %>
    <div class="<%= i.css_classes %> <%= 'starting' if day == i.start_date %> <%= 'ending' if day == i.due_date %> tooltip">
    <%= h("#{i.project} -") unless @project && @project == i.project %>
    <%= link_to_issue i, :truncate => 30 %>
    <span class="tip"><%= render_issue_tooltip i %></span>
    </div>
    <% else %>
    <span class="icon icon-package">
      <%= h("#{i.project} -") unless @project && @project == i.project %>
      <%= link_to_version i%>
    </span>
    <% end %>
  <% end %>
<% end %>

</td>
<%= '</tr><tr>'.html_safe if day.cwday==calendar.last_wday and day!=calendar.enddt %>
<% day = day + 1
end %>
</tr>
</tbody>
</table>